<!DOCTYPE html>
<html>

<head>
    <title>Concept 2 Logbook | Contributions Graph</title>
    <style>
        @font-face {
            font-family: "ProximaNovaRegular";
            src: url("ProximaNova-Regular.ttf") format("truetype"),
                url("ProximaNova-Regular.svg#ProximaNova-Regular") format("svg");
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            font-size: 14px;
            color: #333;
            font-family: ProximaNovaRegular, "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        strong {
            font-family: ProximaNovaSemibold, "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        #details {
            width: 10em;
            display: flex;
            flex-direction: column;
            align-items: baseline;
            margin-top: 1em;
        }

        #details p {
            margin: 0.1em;
        }
    </style>
    <link rel="stylesheet" href="graph.css">
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="inputs.css">
</head>

<body>
    <div class="container">
        <img src="blue.png" alt="Concept 2 Logo" id='c2logo'>
        <i class="fa icon-profile"></i>
    </div>
    <div class="navbar-blue">
        <div class="container">
            <h1>Concept 2 Logbook | Contributions Graph</h1>
        </div>
    </div>
    <p>Connect with you API token to get your graph</p>
    <div class="inputs">
        <input id="token_input" placeholder="API token" maxlength="41" name="APItoken" type="text">
        <button id="connect_btn">Connect</button>
    </div>
    <div class="inputs btn-group">
        <button id="distance_btn" selected="true">Distance</button>
        <button id="time_btn" selected="false">Time</button>
        <button id="workouts_btn" selected="false">Workouts</button>
    </div>
    <div id="graph">
        <ul class="months"></ul>
        <div class="days-squares">
            <ul class="days">
                <li>Sun</li>
                <li>Mon</li>
                <li>Tue</li>
                <li>Wed</li>
                <li>Thu</li>
                <li>Fri</li>
                <li>Sat</li>
            </ul>
            <ul class="squares">
                <!-- added via javascript -->
            </ul>
        </div>
    </div>
    <div id="details">
        <p>Date: <strong id="date_details"></strong></p>
        <p>Meters: <strong id="distance_details"></strong></p>
        <p>Time: <strong id="time_details"></strong></p>
        <p>Workouts: <strong id="workouts_details"></strong></p>
    </div>
    <p id="details"></p>
</body>

<script>
    const squares = document.querySelector('.squares');
    var data = [];
    var date_data = {};
    var selected = "distance";
    var min_date = new Date();
    var end_date = new Date();
    var begin_date = new Date();

    async function get_data_from_url(url, token, contiue = true) {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json\n");
        myHeaders.append("Authorization", "Bearer " + token_input.value);
        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };
        response = await fetch(url, requestOptions);
        if (response.status == 200) {
            result = await response.json();
            // append result.data to data
            data = data.concat(result.data);
            extract_date_dict(result.data);
            draw_graph();
            // console.log(result);
            if (contiue && result.meta.pagination.links.next) {
                await get_data_from_url(result.meta.pagination.links.next, token, contiue);
            }
        } else {
            alert("Invalid token");
        }
    }
    async function get_data_from_token(token) {
        await get_data_from_url("https://log.concept2.com/api/users/me/results?page=1", token, false);
    }
    function extract_date_dict(data) {
        date_data = {};
        for (var i = 0; i < data.length; i++) {
            var item = data[i];
            var date = item.date.substr(0, 10);
            if (date in date_data) {
                date_data[date].distance += item.distance;
                date_data[date].time += item.time;
                date_data[date].number += 1;
            }
            else {
                date_data[date] = {
                    "distance": item.distance,
                    "time": item.time,
                    "number": 1,
                };
                if (new Date(date) < min_date) {
                    min_date = new Date(date);
                }
            }
        }
        return date_data;
    }
    function get_default_dates() {
        end_date = new Date();
        begin_date = new Date();
        begin_date.setFullYear(end_date.getFullYear() - 1);
        while (begin_date.getDay() != 0) {
            begin_date.setDate(begin_date.getDate() + 1);
        }
    }
    function draw_graph() {
        // extract min and max
        date = new Date(begin_date);
        mini = 1000000000;
        maxi = 0;
        while (date <= end_date) {
            date_str = date.toISOString().slice(0, 10);
            if (date_str in date_data) {
                var distance = date_data[date_str].distance;
                var time = date_data[date_str].time;
                var number = date_data[date_str].number;
                if (distance > maxi && selected == "distance") {
                    maxi = distance;
                }
                if (time > maxi && selected == "time") {
                    maxi = time;
                }
                if (number > maxi && selected == "workouts") {
                    maxi = number;
                }
                if (distance < mini && selected == "distance") {
                    mini = distance;
                }
                if (time < mini && selected == "time") {
                    mini = time;
                }
                if (number < mini && selected == "workouts") {
                    mini = number;
                }
            }
            date.setDate(date.getDate() + 1);
        }
        // color squares
        date = new Date(begin_date);
        squares.innerHTML = '';
        while (date <= end_date) {
            date_str = date.toISOString().slice(0, 10);
            if (date_str in date_data) {
                var distance = date_data[date_str].distance;
                var time = date_data[date_str].time;
                var number = date_data[date_str].number;
                if (selected == "distance") {
                    level = Math.floor(1 + (distance - mini) / (maxi - mini) * 2);
                }
                if (selected == "time") {
                    level = Math.floor(1 + (time - mini) / (maxi - mini) * 2);
                }
                if (selected == "workouts") {
                    level = Math.floor(1 + (number - mini) / (maxi - mini) * 2);
                }
                squares.insertAdjacentHTML('beforeend', `<li data-level="${level}"
                onpointerenter="date_details.innerText='${date_str}';distance_details.innerText='${distance}';time_details.innerText='${time}';workouts_details.innerText='${number}'"
                onpointerleave="date_details.innerText='';distance_details.innerText='';time_details.innerText='';workouts_details.innerText=''"></li>`);
            } else {
                squares.insertAdjacentHTML('beforeend', `<li data-level="0"
                onpointerenter="date_details.innerText='${date_str}';distance_details.innerText='0';time_details.innerText='0';workouts_details.innerText='0'"
                onpointerleave="date_details.innerText='';distance_details.innerText='';time_details.innerText='';workouts_details.innerText=''"></li>`);
            }
            date.setDate(date.getDate() + 1);
        }
    }

    distance_btn.onclick = function () {
        distance_btn.setAttribute("selected", "true");
        time_btn.setAttribute("selected", "false");
        workouts_btn.setAttribute("selected", "false");
        selected = "distance";
        draw_graph();
    }
    time_btn.onclick = function () {
        distance_btn.setAttribute("selected", "false");
        time_btn.setAttribute("selected", "true");
        workouts_btn.setAttribute("selected", "false");
        selected = "time";
        draw_graph();
    }
    workouts_btn.onclick = function () {
        distance_btn.setAttribute("selected", "false");
        time_btn.setAttribute("selected", "false");
        workouts_btn.setAttribute("selected", "true");
        selected = "workouts";
        draw_graph();
    }

    connect_btn.onclick = async function () {
        get_default_dates();
        var token = token_input.value;
        console.log(token + " is the token inputted by the user");
        await get_data_from_token(token);
    }
    get_default_dates();
    draw_graph();
</script>

</html>