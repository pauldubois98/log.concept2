<!DOCTYPE html>
<html>

<head>
    <title>Concept 2 Logbook | Contributions Graph</title>
    <style>
        @font-face {
            font-family: "ProximaNovaRegular";
            src: url("ProximaNova-Regular.ttf") format("truetype"),
                url("ProximaNova-Regular.svg#ProximaNova-Regular") format("svg");
        }

        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
            font-size: 14px;
            color: #333;
            font-family: ProximaNovaRegular, "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        strong {
            font-family: ProximaNovaSemibold, "Helvetica Neue", Helvetica, Arial, sans-serif;
        }

        #details {
            width: 10em;
            display: flex;
            flex-direction: column;
            align-items: baseline;
            margin-top: 1em;
        }

        #details p {
            margin: 0.1em;
        }
    </style>
    <link rel="stylesheet" href="graph.css">
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="inputs.css">
</head>

<body>
    <div class="container">
        <img src="blue.png" alt="Concept 2 Logo" id='c2logo'>
        <i class="fa icon-profile"></i>
    </div>
    <div class="navbar-blue">
        <div class="container">
            <h1>Concept 2 Logbook | Contributions Graph</h1>
        </div>
    </div>
    <p>Connect with you API token to get your graph</p>
    <div class="inputs">
        <input id="token_input" placeholder="API token" maxlength="41" name="APItoken" type="text">
        <button id="connect_btn">Connect</button>
    </div>
    <div class="inputs btn-group">
        <button id="total_btn" selected="true">Total</button>
        <button id="active_btn" selected="false">Active</button>
        <button id="rest_btn" selected="false">Rest</button>
    </div>
    <div id="graph">
        <ul class="months"></ul>
        <div class="days-squares">
            <ul class="days">
                <li>Sun</li>
                <li>Mon</li>
                <li>Tue</li>
                <li>Wed</li>
                <li>Thu</li>
                <li>Fri</li>
                <li>Sat</li>
            </ul>
            <ul class="squares">
                <!-- added via javascript -->
            </ul>
        </div>
    </div>
    <div id="details">
        <p>Date: <strong id="date_details"></strong></p>
        <p>Meters: <strong id="distance_details"></strong></p>
        <p>Time: <strong id="time_details"></strong></p>
        <p>Rest Meters: <strong id="rest_distance_details"></strong></p>
        <p>Rest Time: <strong id="rest_time_details"></strong></p>
        <p>Workouts: <strong id="workouts_details"></strong></p>
    </div>
    <p id="details"></p>
</body>

<script>
    const squares = document.querySelector('.squares');
    // var data = [];
    var date_data = {};
    var selected = "total";
    var min_date = new Date();
    var end_date = new Date();
    var begin_date = new Date();

    async function get_data_from_url(url, token, contiue = true) {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json\n");
        myHeaders.append("Authorization", "Bearer " + token_input.value);
        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };
        response = await fetch(url, requestOptions);
        if (response.status == 200) {
            result = await response.json();
            // append result.data to data
            // data = data.concat(result.data);
            extract_date_dict(result.data);
            draw_graph();
            // console.log(result);
            if (contiue && result.meta.pagination.links.next) {
                await get_data_from_url(result.meta.pagination.links.next, token, contiue);
            }
        } else {
            alert("Invalid token");
        }
    }
    async function get_data_from_token(token) {
        await get_data_from_url("https://log.concept2.com/api/users/me/results?page=1", token, false); // to auto load all pages, change to true
    }
    function extract_date_dict(data) {
        for (var i = 0; i < data.length; i++) {
            var item = data[i];
            var date = item.date.substr(0, 10);
            if (date in date_data) {
                date_data[date].distance += item.distance;
                date_data[date].time += item.time;
                date_data[date].number += 1;
                if (item.rest_time == null || item.rest_time == undefined) {
                    item.rest_time = 0;
                }
                if (item.rest_distance == null || item.rest_distance == undefined) {
                    item.rest_distance = 0;
                }
                date_data[date].rest_time += item.rest_time;
                date_data[date].rest_distance += item.rest_distance;
            }
            else {
                if (item.rest_time == null || item.rest_time == undefined) {
                    item.rest_time = 0;
                }
                if (item.rest_distance == null || item.rest_distance == undefined) {
                    item.rest_distance = 0;
                }
                date_data[date] = {
                    "distance": item.distance,
                    "time": item.time,
                    "number": 1,
                    "rest_time": item.rest_time,
                    "rest_distance": item.rest_distance,
                };
                if (new Date(date) < min_date) {
                    min_date = new Date(date);
                }
            }
        }
        return date_data;
    }
    function get_default_dates() {
        end_date = new Date();
        begin_date = new Date();
        begin_date.setFullYear(end_date.getFullYear() - 1);
        while (begin_date.getDay() != 0) {
            begin_date.setDate(begin_date.getDate() + 1);
        }
    }
    function draw_graph() {
        // extract min and max
        date = new Date(begin_date);
        mini = 1000000000;
        maxi = 0;
        while (date <= end_date) {
            date_str = date.toISOString().slice(0, 10);
            if (date_str in date_data) {
                var active = date_data[date_str].distance;
                var rest = date_data[date_str].rest_distance;
                if (isNaN(rest)) {
                    rest = 0;
                }
                var total = active + rest;
                if (total > maxi && selected == "total") {
                    maxi = total;
                }
                if (active > maxi && selected == "active") {
                    maxi = active;
                }
                if (rest > maxi && selected == "rest") {
                    maxi = rest;
                }
                if (total < mini && selected == "total") {
                    mini = total;
                }
                if (active < mini && selected == "active") {
                    mini = active;
                }
                if (rest < mini && selected == "rest") {
                    mini = rest;
                }
            }
            date.setDate(date.getDate() + 1);
        }
        function format_time(t) {
            var tenths = Math.floor(t % 10);
            t = Math.floor(t / 10);
            var seconds = Math.floor(t % 60);
            var minutes = Math.floor(t / 60);
            return minutes + ":" + seconds + '.' + tenths;
        }
        // color squares
        date = new Date(begin_date);
        squares.innerHTML = '';
        while (date <= end_date) {
            date_str = date.toISOString().slice(0, 10);
            if (date_str in date_data) {
                var active = date_data[date_str].distance;
                var rest = date_data[date_str].rest_distance;
                if (isNaN(rest)) {
                    rest = 0;
                }
                var total = active + rest;
                var level = 0;
                if (selected == "total") {
                    level = Math.floor(1 + (total - mini) / (maxi - mini) * 2);
                }
                if (selected == "active") {
                    level = Math.floor(1 + (active - mini) / (maxi - mini) * 2);
                }
                if (selected == "rest") {
                    level = Math.floor(1 + (rest - mini) / (maxi - mini) * 2);
                }
                var active_time = date_data[date_str].time;
                var rest_time = date_data[date_str].rest_time;
                if (isNaN(rest_time)) {
                    rest_time = 0;
                }
                var total_time = active_time + rest_time;
                var number = date_data[date_str].number;
                squares.insertAdjacentHTML('beforeend', `<li data-level="${level}"
                onpointerenter="date_details.innerText='${date_str}';distance_details.innerText='${active}';rest_distance_details.innerText='${rest}';time_details.innerText='${format_time(active_time)}';rest_time_details.innerText='${format_time(rest_time)}';workouts_details.innerText='${number}';"
                onpointerleave="date_details.innerText='';distance_details.innerText='';rest_distance_details.innerText='';time_details.innerText='';rest_time_details.innerText='';workouts_details.innerText=''"></li>`);
            } else {
                squares.insertAdjacentHTML('beforeend', `<li data-level="0"
                onpointerenter="date_details.innerText='${date_str}';distance_details.innerText='0';rest_distance_details.innerText='0';time_details.innerText='0';rest_time_details.innerText='0';workouts_details.innerText='0';"
                onpointerleave="date_details.innerText='';distance_details.innerText='';rest_distance_details.innerText='';time_details.innerText='';rest_time_details.innerText='';workouts_details.innerText=''"></li>`);
            }
            date.setDate(date.getDate() + 1);
        }
    }

    total_btn.onclick = function () {
        total_btn.setAttribute("selected", "true");
        active_btn.setAttribute("selected", "false");
        rest_btn.setAttribute("selected", "false");
        selected = "total";
        draw_graph();
    }
    active_btn.onclick = function () {
        total_btn.setAttribute("selected", "false");
        active_btn.setAttribute("selected", "true");
        rest_btn.setAttribute("selected", "false");
        selected = "active";
        draw_graph();
    }
    rest_btn.onclick = function () {
        total_btn.setAttribute("selected", "false");
        active_btn.setAttribute("selected", "false");
        rest_btn.setAttribute("selected", "true");
        selected = "rest";
        draw_graph();
    }

    connect_btn.onclick = async function () {
        date_data = {};
        get_default_dates();
        var token = token_input.value;
        console.log(token + " is the token inputted by the user");
        await get_data_from_token(token);
    }
    get_default_dates();
    draw_graph();
</script>

</html>