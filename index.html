<!DOCTYPE html>
<html>

<head>
    <title>Concept 2 Logbook | Contributions Graph</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #graph {
            margin-top: 1em;
        }

        .days li:nth-child(odd) {
            visibility: hidden;
        }

        .days li {
            list-style-type: none;
        }

        .months li {
            list-style-type: none;
        }

        .squares {
            display: grid;
            grid-gap: 5px;
            grid-template-rows: repeat(7, 15px);
            grid-auto-flow: column;
            grid-auto-columns: 15px;
        }

        .squares li {
            list-style-type: none;
            background-color: #e1e4e8;
            border-radius: 2px;
        }

        .days-squares {
            display: flex;
        }

        ul {
            display: block;
            padding-left: 5px;
        }

        .squares li[data-level="0"] {
            background-color: #e1e4e8;
        }

        .squares li[data-level="1"] {
            background-color: #c6e48b;
        }

        .squares li[data-level="2"] {
            background-color: #7bc96f;
        }

        .squares li[data-level="3"] {
            background-color: #196127;
        }

        #details {
            width: 10em;
            display: flex;
            flex-direction: column;
            align-items: baseline;
            margin-top: 1em;
        }

        #details p {
            margin: 0.1em;
        }
    </style>
</head>

<body>
    <img src="blue.png" alt="Concept 2 Logo" width="300" height="45">
    <h1>Concept 2 Logbook | Contributions Graph</h1>
    <p>Connect with you API token to get your graph</p>
    <div>
        <input id="token_input" placeholder="<API token>" maxlength="41" name="APItoken" type="text">
        <button id="connect_btn">Connect</button>
    </div>
    <div id="graph">
        <ul class="months"></ul>
        <div class="days-squares">
            <ul class="days">
                <li>Sun</li>
                <li>Mon</li>
                <li>Tue</li>
                <li>Wed</li>
                <li>Thu</li>
                <li>Fri</li>
                <li>Sat</li>
            </ul>
            <ul class="squares">
                <!-- added via javascript -->
            </ul>
        </div>
    </div>
    <div id="details">
        <p>Date: <span id="date_details"></span></p>
        <p>Meters: <span id="distance_details"></span></p>
        <p>Time: <span id="time_details"></span></p>
        <p>Workouts: <span id="workouts_details"></span></p>
    </div>
    <p id="details"></p>
</body>

<script>
    const squares = document.querySelector('.squares');
    for (var i = 1; i < 360; i++) {
        squares.insertAdjacentHTML('afterbegin', `<li></li>`);
    }

    // var data = [];
    var date_data = {};
    var min_date = new Date();
    var end_date = new Date();
    var begin_date = new Date();

    async function get_data_from_url(url, token, contiue = true) {
        const myHeaders = new Headers();
        myHeaders.append("Content-Type", "application/json\n");
        myHeaders.append("Authorization", "Bearer " + token_input.value);
        const requestOptions = {
            method: "GET",
            headers: myHeaders,
            redirect: "follow"
        };
        response = await fetch(url, requestOptions);
        if (response.status == 200) {
            result = await response.json();
            // append result.data to data
            // data = data.concat(result.data);
            extract_date_dict(result.data);
            draw_graph();
            // console.log(result);
            if (contiue && result.meta.pagination.links.next) {
                await get_data_from_url(result.meta.pagination.links.next, token, contiue);
            }
        } else {
            alert("Invalid token");
        }
    }
    async function get_data_from_token(token) {
        await get_data_from_url("https://log.concept2.com/api/users/me/results?page=1", token, false);
    }
    function extract_date_dict(data) {
        date_data = {};
        for (var i = 0; i < data.length; i++) {
            var item = data[i];
            var date = item.date.substr(0, 10);
            if (date in date_data) {
                date_data[date].distance += item.distance;
                date_data[date].time += item.time;
                date_data[date].number += 1;
            }
            else {
                date_data[date] = {
                    "distance": item.distance,
                    "time": item.time,
                    "number": 1,
                };
                if (new Date(date) < min_date) {
                    min_date = new Date(date);
                }
            }
        }
        return date_data;
    }
    function get_default_dates() {
        end_date = new Date();
        begin_date = new Date();
        begin_date.setFullYear(end_date.getFullYear() - 1);
        while (begin_date.getDay() != 0) {
            begin_date.setDate(begin_date.getDate() + 1);
        }
    }
    function draw_graph() {
        // extract min and max
        date = new Date(begin_date);
        mini = 1000000000;
        maxi = 0;
        while (date <= end_date) {
            date_str = date.toISOString().slice(0, 10);
            if (date_str in date_data) {
                var distance = date_data[date_str].distance;
                var time = date_data[date_str].time;
                var number = date_data[date_str].number;
                if (distance > maxi) {
                    maxi = distance;
                }
                if (distance < mini) {
                    mini = distance;
                }
            }
            date.setDate(date.getDate() + 1);
        }
        // color squares
        date = new Date(begin_date);
        squares.innerHTML = '';
        while (date <= end_date) {
            date_str = date.toISOString().slice(0, 10);
            if (date_str in date_data) {
                var distance = date_data[date_str].distance;
                var time = date_data[date_str].time;
                var number = date_data[date_str].number;
                level = Math.floor(1 + (distance - mini) / (maxi - mini) * 2);
                squares.insertAdjacentHTML('beforeend', `<li data-level="${level}"
                onpointerenter="date_details.innerText='${date_str}';distance_details.innerText='${distance}';time_details.innerText='${time}';workouts_details.innerText='${number}'"
                onpointerleave="date_details.innerText='';distance_details.innerText='';time_details.innerText='';workouts_details.innerText=''"></li>`);
            } else {
                squares.insertAdjacentHTML('beforeend', `<li data-level="0"
                onpointerenter="date_details.innerText='${date_str}';distance_details.innerText='0';time_details.innerText='0';workouts_details.innerText='0'"
                onpointerleave="date_details.innerText='';distance_details.innerText='';time_details.innerText='';workouts_details.innerText=''"></li>`);
            }
            date.setDate(date.getDate() + 1);
        }
    }

    connect_btn.onclick = async function () {
        get_default_dates();
        var token = token_input.value;
        console.log(token + " is the token inputted by the user");
        await get_data_from_token(token);
    }
</script>

</html>